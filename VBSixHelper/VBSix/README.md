# VBSix: A C# Library for Parsing Visual Basic 6 Files

VBSix is a .NET library designed for parsing various Visual Basic 6 (VB6) file formats, including project files (`.vbp`), form files (`.frm`), class modules (`.cls`), and standard modules (`.bas`).

The primary goal of this library is to enable developers to analyze, understand, and potentially migrate or refactor legacy VB6 applications by providing structured access to their source code and project metadata.

## Features

*   **Project File Parsing (`.vbp`)**:
    *   Extracts project type (Exe, OleDll, Control, OleExe).
    *   Parses references to external components (COM objects, other VB6 projects).
    *   Identifies constituent modules, classes, forms, user controls, and user documents.
    *   Reads project-level properties like startup object, version information, compilation settings, etc.
*   **Form File Parsing (`.frm`)**:
    *   Parses the form's header version and `Object=` references to ActiveX controls.
    *   Extracts the hierarchical structure of controls on the form, including nested controls (e.g., controls within a Frame).
    *   Parses properties for standard VB6 controls (TextBox, CommandButton, Label, etc.) and their values.
    *   Handles `BeginProperty...EndProperty` blocks for complex properties like `Font`.
    *   Supports resolution of binary resources (images, icons, list items) from associated `.frx` files via a pluggable `ResourceFileResolver`. A default file-based resolver is provided.
    *   Parses `Attribute` statements (e.g., `VB_Name`, `VB_Exposed`).
    *   Tokenizes the VB6 code section of the form module.
*   **Class Module Parsing (`.cls`)**:
    *   Parses the class header: `VERSION 1.0 CLASS`.
    *   Extracts `Attribute` statements (e.g., `VB_Name`, `VB_Creatable`, `VB_Exposed`).
    *   Parses COM-related properties from the `BEGIN...END` block (e.g., `MultiUse`, `Persistable`, `MTSTransactionMode`).
    *   Tokenizes the VB6 code within the class module.
*   **Standard Module Parsing (`.bas`)**:
    *   Extracts the module name from the `Attribute VB_Name = "..."` line.
    *   Tokenizes the VB6 code within the module.
*   **VB6 Code Tokenization**:
    *   Provides a tokenizer that breaks down VB6 code into a stream of `VB6Token` objects (keywords, identifiers, literals, operators, comments, etc.).
    *   Handles line continuation characters (`_`).
    *   Identifies single-quote (`'`) and `REM` comments.
    *   Parses string literals, including escaped double quotes (`""`).
*   **Error Handling**:
    *   Provides detailed `VB6ParseException` exceptions with information about the error kind, file name, source location (line, column, offset), and a snippet of the source code.
*   **Extensibility**:
    *   Designed to potentially support custom controls in forms by storing their properties in a raw format.

## Design Goals

*   **Accuracy**: Strive for accurate parsing of valid VB6 file structures as generated by the VB6 IDE.
*   **Structured Data**: Provide parsed data in well-defined C# classes and enums for easy consumption.
*   **Error Reporting**: Offer meaningful error messages to help diagnose issues with malformed or unsupported VB6 files.
*   **Maintainability**: C# code structured for clarity and ease of maintenance.

## Project Structure

The library is organized into the following main namespaces/directories:

*   `VBSix/`
    *   `Errors/`: Contains error and exception-related classes (`VB6ParseException`, `VB6ErrorKind`, `PropertyErrorType`).
    *   `Language/`: Defines language-specific constructs.
        *   `Controls/`: Contains classes for control properties (`TextBoxProperties`, `FormProperties`, etc.) and control-related enums (`Appearance`, `BorderStyle`, etc.).
        *   `VB6Color.cs`: Represents VB6 colors and predefined constants.
        *   `Tokens.cs`: Defines `VB6Token` and `VB6TokenType`.
    *   `Parsers/`: Contains the core parsing logic and data structures for different file types.
        *   `HeaderData.cs`, `HeaderParser.cs`: For common header parsing.
        *   `VB6Stream.cs`: Input stream management.
        *   `Properties.cs`: Wrapper for raw control properties.
        *   `Vb6.cs`: Core VB6 code tokenization.
        *   `CompilationSettings.cs`: Project compilation settings.
        *   `VB6ObjectReference.cs`: For `Object=` lines.
        *   `VB6ClassFile.cs`, `VB6ModuleFile.cs`, `VB6FormFile.cs`, `Project.cs`: Parsers for specific file types.
    *   `Utilities/`: Helper classes.
        *   `PropertyParserHelpers.cs`: Extension methods for parsing typed properties.
        *   `TwipsConverter.cs`: For unit conversions.

## Basic Usage Examples

*(These examples assume the library is referenced in your C# project.)*

### Parsing a VBP Project File

```csharp
using VBSix.Parsers;
using System.IO;
using System.Text;

// ...

string vbpFilePath = "path/to/your/project.vbp";
try
{
    // VB6 files are typically ANSI encoded (Windows-1252 for English systems)
    byte[] vbpBytes = File.ReadAllBytes(vbpFilePath);
    VB6Project project = VB6Project.ParseFromBytes(vbpFilePath, vbpBytes); // Or VB6Project.ParseFile(vbpFilePath);

    Console.WriteLine($"Project Name: {project.Name ?? "(None)"}");
    Console.WriteLine($"Project Type: {project.ProjectType}");
    Console.WriteLine($"Startup Object: {project.Startup ?? "(None)"}");
    Console.WriteLine($"Number of Forms: {project.Forms.Count}");
    foreach (var formPath in project.Forms)
    {
        Console.WriteLine($"  Form: {formPath}");
    }
    // Access other project properties...
}
catch (VB6ParseException ex)
{
    Console.Error.WriteLine($"Error parsing VBP file '{ex.FileName}': {ex.Message}");
    Console.Error.WriteLine($"Location: Line {ex.LineNumber}, Col {ex.Column}, Offset {ex.SourceOffset}");
    Console.Error.WriteLine($"Source Snippet: {ex.SourceCode}");
    if (ex.InnerException != null)
    {
        Console.Error.WriteLine($"Inner Exception: {ex.InnerException.Message}");
    }
}
catch (IOException ex)
{
    Console.Error.WriteLine($"File I/O error for {vbpFilePath}: {ex.Message}");
}
```

### Parsing a FRM Form File

```csharp
using VBSix.Parsers;
using VBSix.Language.Controls; // For accessing specific control kinds
using System.IO;
using System.Text;

// ...

string frmFilePath = "path/to/your/form.frm";
try
{
    byte[] frmBytes = File.ReadAllBytes(frmFilePath);
    // VB6FormFile.Parse uses a default resource resolver that looks for .frx files
    // in the same directory as the .frm file.
    VB6FormFile formFile = VB6FormFile.Parse(frmFilePath, frmBytes);

    Console.WriteLine($"Form Name (from Attribute VB_Name): {formFile.Attributes.Name}");
    if (formFile.Form != null)
    {
        Console.WriteLine($"Form Object Name (from BEGIN line): {formFile.Form.Name}");
        if (formFile.Form.Kind is VB6FormKind formKind && formKind.TypedProperties != null)
        {
            Console.WriteLine($"  Form Caption: {formKind.TypedProperties.Caption}");
            Console.WriteLine($"  Number of controls on form: {formKind.Controls.Count}");
            // Iterate through formKind.Controls to inspect individual controls
            foreach (var control in formKind.Controls)
            {
                Console.WriteLine($"    Control: {control.Name}, Type: {control.Kind?.GetType().Name}");
                if (control.Kind is VB6TextBoxKind textBoxKind && textBoxKind.TypedProperties != null)
                {
                    Console.WriteLine($"      Text: {textBoxKind.TypedProperties.Text}");
                }
            }
        }
    }
    // Access tokenized code part: formFile.Tokens
}
catch (VB6ParseException ex)
{
    Console.Error.WriteLine($"Error parsing FRM file '{ex.FileName}': {ex.Message}");
    // ... (more error details as above) ...
}
catch (IOException ex)
{
    Console.Error.WriteLine($"File I/O error for {frmFilePath}: {ex.Message}");
}
```

### Parsing a CLS Class File

```csharp
using VBSix.Parsers;
using System.IO;
using System.Text;

// ...

string clsFilePath = "path/to/your/class.cls";
try
{
    byte[] clsBytes = File.ReadAllBytes(clsFilePath);
    VB6ClassFile classFile = VB6ClassFile.Parse(clsFilePath, clsBytes);

    Console.WriteLine($"Class Name: {classFile.Header.Attributes.Name}");
    Console.WriteLine($"  Creatable: {classFile.Header.Attributes.Creatable}");
    Console.WriteLine($"  MultiUse: {classFile.Header.Properties.MultiUse}");
    Console.WriteLine($"  Number of tokens: {classFile.Tokens.Count}");
    // Access other class properties and tokens...
}
catch (VB6ParseException ex)
{
    Console.Error.WriteLine($"Error parsing CLS file '{ex.FileName}': {ex.Message}");
    // ... (more error details as above) ...
}
catch (IOException ex)
{
    Console.Error.WriteLine($"File I/O error for {clsFilePath}: {ex.Message}");
}
```

## Building

This project can be built using a standard .NET SDK (e.g., .NET 6/7/8/9). Create a C# class library project and add the provided `.cs` files to it.

```bash
dotnet build
```

## Dependencies

This library aims to have minimal external dependencies. Standard .NET libraries are used.

## Contributions

Contributions, bug reports, and feature requests are welcome. Please open an issue or submit a pull request on the project repository (if applicable).

## License

*(Specify your chosen license here, e.g., MIT, Apache 2.0. If based on the .NET project, ensure license compatibility.)*

This project is licensed under the [MIT License](LICENSE.txt).